<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RR Ã— NIGHT CITY</title>

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>

<style>
body{
 margin:0;
 height:100vh;
 background:#0a0015;
 color:#00ffff;
 font-family:monospace;
 display:flex;
 flex-direction:column;
 align-items:center;
 justify-content:center;
}
.screen{display:none;flex-direction:column;align-items:center}
.screen.active{display:flex}

input,button{
 margin:10px;
 padding:10px 20px;
 font-size:1.2rem;
 background:black;
 border:2px solid #00ffff;
 color:#00ffff;
}

.player-card{
 padding:6px 15px;
 margin:5px;
 border:1px solid #c300ff;
}
.player-card.dead{opacity:.3;text-decoration:line-through}
</style>
</head>
<body>

<div id="startScreen" class="screen active">
<h1>RUSSIAN ROULETTE</h1>
<input id="nameInput" placeholder="Nickname">
<button id="startBtn">ENTER</button>
</div>

<div id="lobbyScreen" class="screen">
<h2 id="lobbyCodeDisplay"></h2>
<div id="playersBox"></div>
<button id="addKI">ADD KI</button>
<button id="startGame">START</button>
</div>

<div id="gameScreen" class="screen">
<h2 id="turnDisplay"></h2>
<div id="playersGame"></div>
<div id="chatBox" style="border:1px solid #00ffff;height:150px;overflow:auto;width:300px"></div>
<input id="chatInput"><button id="sendChat">SEND</button>
</div>

<script>
const firebaseConfig = {
 apiKey:"AIzaSyBa5w0hQ1v7Nowk-BvDgkGeNRNf1WJtDgw",
 authDomain:"rrweb-dc73f.firebaseapp.com",
 databaseURL:"https://rrweb-dc73f-default-rtdb.europe-west1.firebasedatabase.app",
 projectId:"rrweb-dc73f"
};

firebase.initializeApp(firebaseConfig);
const db=firebase.database();
const auth=firebase.auth();

let user;
let lobbyCode;
let gameRef;
let myKey=null;
let players=[];

auth.signInAnonymously();
auth.onAuthStateChanged(u=>user=u);

function show(id){
 document.querySelectorAll('.screen')
  .forEach(s=>s.classList.remove('active'));
 document.getElementById(id).classList.add('active');
}

document.getElementById("startBtn").onclick=()=>{
 lobbyCode=Math.random().toString(36).slice(2,6).toUpperCase();
 show("lobbyScreen");
 document.getElementById("lobbyCodeDisplay").textContent="Lobby: "+lobbyCode;
 joinLobby();
};

function joinLobby(){
 if(!user){setTimeout(joinLobby,200);return;}

 gameRef=db.ref("lobbies/"+lobbyCode);

 const newRef=gameRef.child("players").push();
 myKey=newRef.key;

 newRef.set({
   name:document.getElementById("nameInput").value||"Player",
   uid:user.uid,
   alive:true,
   isKI:false
 });

 // ðŸ‘‡ Entfernen wenn disconnect
 newRef.onDisconnect().remove();

 gameRef.on("value",snap=>{
   const val=snap.val()||{};
   players=Object.entries(val.players||{})
    .map(([k,v])=>({key:k,...v}));

   updateLobbyUI();
 });

 window.addEventListener("beforeunload",cleanupOnLeave);
}

function cleanupOnLeave(){
 if(!myKey) return;
 db.ref("lobbies/"+lobbyCode+"/players/"+myKey)
   .remove()
   .then(checkLobbyCleanup);
}

// ðŸ”¥ Hier passiert Magie
function checkLobbyCleanup(){
 db.ref("lobbies/"+lobbyCode+"/players").once("value")
  .then(snap=>{
   const data=snap.val()||{};
   const realPlayers=Object.values(data)
     .filter(p=>!p.isKI);

   if(realPlayers.length===0){
     db.ref("lobbies/"+lobbyCode+"/chat").remove();
   }
 });
}

function updateLobbyUI(){
 document.getElementById("playersBox").innerHTML=
 players.map(p=>
 `<div class="player-card ${p.alive?'':'dead'}">
 ${p.name}${p.isKI?' ðŸ¤–':''}
 </div>`
 ).join("");
}

document.getElementById("addKI").onclick=()=>{
 gameRef.child("players").push({
   name:"KI-"+Math.floor(Math.random()*99),
   uid:"ki"+Date.now(),
   alive:true,
   isKI:true
 });
};

// ðŸ’¬ CHAT
function initChat(){
 const chatRef=db.ref("lobbies/"+lobbyCode+"/chat");

 chatRef.limitToLast(50).on("child_added",snap=>{
   const msg=snap.val();
   const d=document.createElement("div");
   d.textContent=msg.name+": "+msg.text;
   document.getElementById("chatBox").appendChild(d);
 });
}

document.getElementById("sendChat").onclick=()=>{
 const text=document.getElementById("chatInput").value.trim();
 if(!text) return;

 db.ref("lobbies/"+lobbyCode+"/chat").push({
   name:document.getElementById("nameInput").value||"Player",
   text:text,
   time:Date.now()
 });

 document.getElementById("chatInput").value="";
};

</script>
</body>
</html>
