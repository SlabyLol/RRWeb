<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RUSSIAN ROULETTE Ã— NIGHT CITY</title>

  <script type="module">
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Firebase 12.x modular (deine Config)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, update, transaction, push, remove, get } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBa5w0hQ1v7Nowk-BvDgkGeNRNf1WJtDgw",
      authDomain: "rrweb-dc73f.firebaseapp.com",
      projectId: "rrweb-dc73f",
      storageBucket: "rrweb-dc73f.firebasestorage.app",
      messagingSenderId: "247426843219",
      appId: "1:247426843219:web:c466e97fd59ee160c9bca6",
      databaseURL: "https://rrweb-dc73f-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let user = null;
    let playerName = localStorage.getItem('rr_handle') || '';
    let lobbyCode = '';
    let isHost = false;
    let myPlayerKey = null;
    let gameRef = null;
    let players = [];
    let gameState = { started: false, bulletPos: -1, currentPos: 0, currentTurn: 0, chambers: 6 };

    onAuthStateChanged(auth, u => { user = u; });
    signInAnonymously(auth).catch(err => console.error("Anonym Login Fehler:", err));

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function createBangParticles() {
      const container = document.getElementById('particles');
      for (let i = 0; i < 70; i++) {
        const p = document.createElement('div');
        p.style.cssText = `
          position:absolute; width:6px; height:6px; border-radius:50%;
          background:${Math.random()>0.5 ? '#ff2a8c' : Math.random()>0.5 ? '#00faff' : '#ffff00'};
          left:50%; top:38%; pointer-events:none; transform:translate(-50%,-50%);
          animation: fly ${0.6 + Math.random()*1}s forwards;
        `;
        container.appendChild(p);
        setTimeout(() => p.remove(), 2000);
      }
    }

    // â”€â”€â”€ Startbildschirm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const nameInput   = document.getElementById('playerName');
    const connectBtn  = document.getElementById('connectBtn');
    const gunIntro    = document.getElementById('gunIntro');

    if (playerName) nameInput.value = playerName;

    function startGameFlow() {
      playerName = nameInput.value.trim();
      if (!playerName) {
        alert("Gib bitte einen Handle ein, Choom!");
        nameInput.focus();
        return;
      }
      localStorage.setItem('rr_handle', playerName);
      showScreen('lobbyScreen');
      document.getElementById('lobbyPlayerName').textContent = playerName;
    }

    // ALLE drei Wege funktionieren:
    nameInput.addEventListener('keypress', e => { if (e.key === 'Enter') startGameFlow(); });
    connectBtn.addEventListener('click', startGameFlow);
    gunIntro.addEventListener('click', startGameFlow);

    gunIntro.addEventListener('mouseenter', () => { gunIntro.style.animationDuration = '2.8s'; });
    gunIntro.addEventListener('mouseleave', () => { gunIntro.style.animationDuration = '7s'; });

    // â”€â”€â”€ Lobby â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('createLobby').onclick = () => {
      lobbyCode = Math.random().toString(36).slice(2,6).toUpperCase();
      document.getElementById('lobbyCodeDisplay').textContent = lobbyCode;
      document.getElementById('hostBadge').style.display = 'inline-block';
      isHost = true;
      joinOrCreateLobby();
    };

    document.getElementById('joinLobbyBtn').onclick = () => {
      const code = document.getElementById('joinCodeInput').value.trim().toUpperCase();
      if (code.length !== 4) return alert('Code muss genau 4 Zeichen haben!');
      lobbyCode = code;
      document.getElementById('lobbyCodeDisplay').textContent = lobbyCode;
      joinOrCreateLobby();
    };

    function joinOrCreateLobby() {
      gameRef = ref(db, `lobbies/${lobbyCode}`);
      const playersRef = ref(db, `lobbies/${lobbyCode}/players`);

      get(playersRef).then(snap => {
        const existing = snap.val() || {};
        const alreadyIn = Object.values(existing).some(p => p.uid === (user?.uid || 'temp'));

        if (!alreadyIn) {
          const newPlayerRef = push(playersRef);
          myPlayerKey = newPlayerRef.key;
          set(newPlayerRef, {
            name: playerName,
            uid: user?.uid || 'local',
            alive: true,
            isKI: false
          });
        }

        onValue(gameRef, snap => {
          const data = snap.val() || {};
          players = Object.entries(data.players || {}).map(([k, v]) => ({ key: k, ...v }));
          gameState = { ...gameState, ...(data.gameState || {}) };
          updateLobbyAndGame();
        });
      }).catch(err => console.error("Lobby join Fehler:", err));
    }

    function updateLobbyAndGame() {
      const list = document.getElementById('lobbyPlayers');
      list.innerHTML = players.map(p => `
        <div class="player-card ${p.alive ? 'alive' : 'dead'} ${p.isKI ? 'ki' : ''}">
          ${p.name}${p.isKI ? ' <span>ðŸ¤–</span>' : ''}
        </div>
      `).join('');

      document.getElementById('startGame').disabled = !isHost || players.length < 2;

      if (gameState.started) {
        showScreen('gameScreen');
        updateGameScreen();
      }
    }

    document.getElementById('addKI').onclick = () => {
      if (!isHost) return;
      const kiRef = push(ref(db, `lobbies/${lobbyCode}/players`));
      set(kiRef, {
        name: `KI-${Math.floor(Math.random()*100)}`,
        uid: `ki_${Date.now()}`,
        alive: true,
        isKI: true
      });
    };

    document.getElementById('startGame').onclick = () => {
      if (!isHost) return;
      update(ref(db, `lobbies/${lobbyCode}/gameState`), {
        started: true,
        bulletPos: Math.floor(Math.random() * 6),
        currentPos: 0,
        currentTurn: 0
      });
    };

    // â”€â”€â”€ Spiel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateGameScreen() {
      const currPlayer = players[gameState.currentTurn] || { name: '???' };
      document.getElementById('currentTurnDisplay').textContent = `Dran: ${currPlayer.name}`;

      const gamePlayersDiv = document.getElementById('gamePlayers');
      gamePlayersDiv.innerHTML = players.map(p => `
        <div class="player-card ${p.alive ? 'alive' : 'dead'} ${p.isKI ? 'ki' : ''} ${players.indexOf(p) === gameState.currentTurn ? 'current' : ''}">
          ${p.name}${p.isKI ? ' ðŸ¤–' : ''}
        </div>
      `).join('');

      const shotsLeft = gameState.chambers - gameState.currentPos - 1;
      document.getElementById('status').textContent = shotsLeft >= 0 ? `Noch ${shotsLeft} Schuss${shotsLeft !== 1 ? 'e' : ''}...` : 'Trommel leer';

      const myTurn = (players[gameState.currentTurn]?.uid === (user?.uid || 'temp')) && !players[gameState.currentTurn]?.isKI;
      ['shoot', 'doubleShoot', 'giveUp', 'spin'].forEach(id => {
        document.getElementById(id).disabled = !myTurn;
      });

      // KI Auto-Play
      if (players[gameState.currentTurn]?.isKI) {
        setTimeout(() => {
          if (Math.random() > 0.4) {
            document.getElementById('shoot').click();
          } else {
            document.getElementById('doubleShoot').click();
          }
        }, 1800 + Math.random() * 3000);
      }
    }

    function doShoot(multi = 1) {
      const gun = document.getElementById('gun');
      gun.classList.add('shoot');
      setTimeout(() => gun.classList.remove('shoot'), 500);
      createBangParticles();

      let pos = gameState.currentPos;
      let bang = false;

      for (let i = 0; i < multi; i++) {
        pos = (pos + 1) % gameState.chambers;
        if (pos === gameState.bulletPos) {
          bang = true;
          break;
        }
      }

      if (bang) {
        const loserKey = players[gameState.currentTurn].key;
        update(ref(db, `lobbies/${lobbyCode}/players/${loserKey}`), { alive: false });
        document.getElementById('status').textContent = `BANG!!! ${players[gameState.currentTurn].name} ist tot!`;
        checkEndGame();
      } else {
        update(ref(db, `lobbies/${lobbyCode}/gameState`), { currentPos: pos });
        transaction(ref(db, `lobbies/${lobbyCode}/gameState/currentTurn`), turn => {
          let next = (turn + 1) % players.length;
          while (!players[next]?.alive) next = (next + 1) % players.length;
          return next;
        });
      }
    }

    document.getElementById('shoot').onclick       = () => doShoot(1);
    document.getElementById('doubleShoot').onclick = () => doShoot(2);
    document.getElementById('giveUp').onclick = () => {
      const key = players[gameState.currentTurn].key;
      update(ref(db, `lobbies/${lobbyCode}/players/${key}`), { alive: false });
      document.getElementById('status').textContent = `${players[gameState.currentTurn].name} gibt auf...`;
      checkEndGame();
    };

    document.getElementById('spin').onclick = () => {
      update(ref(db, `lobbies/${lobbyCode}/gameState`), {
        bulletPos: Math.floor(Math.random() * 6),
        currentPos: 0
      });
    };

    function checkEndGame() {
      const aliveCount = players.filter(p => p.alive).length;
      if (aliveCount <= 1) {
        setTimeout(() => {
          const winner = aliveCount === 1 ? players.find(p => p.alive)?.name : 'Niemand';
          alert(`Spiel vorbei! Gewinner: ${winner}`);
          location.reload();
        }, 2500);
      }
    }

    document.getElementById('gun').onclick = () => {
      if (!document.getElementById('shoot').disabled) doShoot(1);
    };

    // Live-Update
    setInterval(updateGameScreen, 500);
  </script>

  <style>
    :root {
      --neon-pink: #ff2a8c;
      --neon-cyan: #00faff;
      --neon-purple: #c300ff;
      --dark: #0b0014;
    }
    body {
      margin:0; height:100vh; background:var(--dark); color:#e0f8ff; font-family:'Courier New',monospace; overflow:hidden;
    }
    body::before {
      content:""; position:fixed; inset:0; z-index:9999; pointer-events:none;
      background: repeating-linear-gradient(transparent 0 2px, rgba(0,0,0,0.55) 2px 4px);
      animation: scanline 14s linear infinite;
    }
    @keyframes scanline { 0% { transform:translateY(-100%); } 100% { transform:translateY(100%); } }

    .screen { position:absolute; inset:0; display:none; flex-direction:column; align-items:center; justify-content:center; z-index:10; }
    .screen.active { display:flex; }

    .title-glitch {
      font-size: clamp(4.5rem, 14vw, 10rem);
      font-weight:900; text-transform:uppercase; letter-spacing:0.4em;
      color:#fff; text-shadow:0 0 20px var(--neon-cyan), 0 0 50px var(--neon-pink);
      position:relative; animation:glitch 5s infinite;
    }
    .title-glitch::before, .title-glitch::after {
      content:attr(data-text); position:absolute; inset:0; background:var(--dark); clip:rect(0,9999px,0,0);
    }
    .title-glitch::before { left:4px; text-shadow:-6px 0 var(--neon-pink); animation:glitch1 2.2s infinite alternate-reverse; }
    .title-glitch::after  { left:-4px; text-shadow:6px 0 var(--neon-cyan);  animation:glitch2 3.1s infinite alternate-reverse; }

    @keyframes glitch  { 0%,100%{transform:translate(0)} 3%,7%,11%{transform:translate(5px,-5px)} }
    @keyframes glitch1 { 0%{clip:rect(25px,9999px,55px,0)} 20%{clip:rect(75px,9999px,115px,0)} 40%{clip:rect(10px,9999px,50px,0)} 60%{clip:rect(90px,9999px,140px,0)} 100%{clip:rect(40px,9999px,80px,0)} }
    @keyframes glitch2 { 0%{clip:rect(70px,9999px,110px,0)} 25%{clip:rect(20px,9999px,60px,0)} 50%{clip:rect(100px,9999px,150px,0)} 75%{clip:rect(50px,9999px,90px,0)} 100%{clip:rect(5px,9999px,45px,0)} }

    .gun-intro { font-size:clamp(12rem, 35vw, 24rem); filter:drop-shadow(0 0 90px var(--neon-pink)) drop-shadow(0 0 160px var(--neon-cyan)); animation:breath 8s ease-in-out infinite; cursor:pointer; user-select:none; margin:50px 0; }
    @keyframes breath { 0%,100%{transform:scale(1) rotate(-15deg)} 50%{transform:scale(1.08) rotate(15deg)} }

    input, button.btn {
      padding:20px 50px; font-size:1.7rem; margin:25px; border:3px solid; background:transparent; color:inherit;
      font-family:inherit; cursor:pointer; transition:all 0.35s; letter-spacing:1px;
    }
    input { border-color:var(--neon-cyan); box-shadow:0 0 40px rgba(0,250,255,0.45); width:420px; max-width:92%; text-align:center; }
    input:focus { border-color:var(--neon-pink); box-shadow:0 0 70px rgba(255,42,140,0.8); outline:none; }
    button.btn { border-color:var(--neon-pink); color:var(--neon-pink); box-shadow:0 0 35px rgba(255,42,140,0.6); }
    button.btn:hover { background:var(--neon-pink); color:#000; box-shadow:0 0 80px var(--neon-pink); transform:translateY(-6px); }

    .player-card {
      background:rgba(30,0,60,0.65); border:2px solid var(--neon-purple); padding:16px 32px; margin:12px;
      min-width:170px; text-align:center; box-shadow:0 0 30px rgba(195,0,255,0.5); transition:all 0.3s;
    }
    .player-card.alive:hover { transform:scale(1.1); border-color:var(--neon-cyan); }
    .player-card.current { animation:pulse 1.5s infinite; border-color:#ffff66; box-shadow:0 0 50px #ffff6680; }
    .player-card.ki { border-color:#00faff; }

    #gun { font-size:200px; transform:rotate(-18deg); filter:drop-shadow(0 0 50px var(--neon-pink)); transition:all 0.5s cubic-bezier(0.68,-0.55,0.265,1.55); cursor:pointer; }
    #gun.shoot { transform:rotate(-18deg) translateY(-50px) scale(1.2); filter:drop-shadow(0 0 100px #ff0044) brightness(1.7); }

    #status { font-size:2.4rem; margin:40px 0; text-shadow:0 0 25px currentColor; min-height:70px; text-align:center; }

    #particles { position:fixed; inset:0; pointer-events:none; z-index:5; }

    @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.07)} }
  </style>
</head>
<body>

<div id="particles"></div>

<div id="nameScreen" class="screen active">
  <h1 class="title-glitch" data-text="RUSSIAN ROULETTE">RUSSIAN ROULETTE</h1>
  <div class="gun-intro" id="gunIntro">ðŸ”«</div>
  <input id="playerName" placeholder="DEIN HANDLE / NICKNAME" maxlength="16" autofocus>
  <button class="btn" id="connectBtn">START / CONNECT</button>
</div>

<div id="lobbyScreen" class="screen">
  <h1 class="title-glitch" data-text="LOBBY">LOBBY</h1>
  <div id="lobbyCodeDisplay" style="font-size:5rem; color:var(--neon-pink); margin:30px 0; letter-spacing:10px;">----</div>
  <div id="hostBadge" style="color:var(--neon-cyan); font-size:2rem; display:none; margin-bottom:20px;">YOU ARE HOST</div>
  <div style="font-size:1.8rem; margin:20px 0;">Handle: <span id="lobbyPlayerName">...</span></div>
  <div id="lobbyPlayers" style="display:flex; flex-wrap:wrap; justify-content:center; max-width:95%;"></div>

  <div style="margin-top:60px; display:flex; flex-wrap:wrap; gap:20px; justify-content:center;">
    <button class="btn" id="createLobby">CREATE LOBBY</button>
    <button class="btn" id="joinLobbyBtn">JOIN LOBBY</button>
    <input id="joinCodeInput" placeholder="CODE" maxlength="4" style="width:160px; font-size:2.2rem; text-align:center; padding:18px;">
    <button class="btn" id="addKI">+ KI SPIELER</button>
    <button class="btn" id="startGame" disabled>START GAME</button>
  </div>
</div>

<div id="gameScreen" class="screen">
  <h1 class="title-glitch" data-text="GAME ON">GAME ON</h1>
  <div id="currentTurnDisplay" style="font-size:3.5rem; color:#ffff66; margin:30px 0; text-shadow:0 0 40px #ffff66;">Dran: ...</div>

  <div style="position:relative; margin:40px 0;">
    <div id="gun">ðŸ”«</div>
  </div>

  <div id="status" style="color:var(--neon-cyan);">Warte auf den ersten Schuss...</div>

  <div id="gamePlayers" style="display:flex; flex-wrap:wrap; justify-content:center; max-width:95%; margin:40px 0;"></div>

  <div style="margin-top:50px; display:flex; flex-wrap:wrap; gap:25px; justify-content:center;">
    <button class="btn" id="spin">SPIN CHAMBER</button>
    <button class="btn" id="shoot">SHOOT Ã—1</button>
    <button class="btn" id="doubleShoot">SHOOT Ã—2 âš¡</button>
    <button class="btn" id="giveUp" style="border-color:#ff0044; color:#ff6666; box-shadow:0 0 40px rgba(255,0,68,0.6);">GIVE UP</button>
  </div>
</div>

</body>
</html>
