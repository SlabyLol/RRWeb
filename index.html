<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RUSSIAN ROULETTE Ã— NIGHT CITY</title>

  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>

  <style>
    :root {
      --pink: #ff0044;
      --cyan: #00ffff;
      --purple: #c300ff;
      --dark: #0a0015;
    }
    body {
      margin:0; height:100vh; background:var(--dark);
      color:#e8f0ff; font-family:'Courier New',monospace; overflow:hidden;
    }
    .screen { position:absolute; inset:0; display:none; flex-direction:column; align-items:center; justify-content:center; z-index:10; padding:20px; }
    .screen.active { display:flex; }

    .title {
      font-size: clamp(5rem, 15vw, 12rem);
      font-weight:900; text-transform:uppercase; letter-spacing:0.5em;
      color:#fff; text-shadow:0 0 25px var(--cyan), 0 0 70px var(--pink);
      position:relative; animation:glitch 5s infinite;
    }
    .title::before, .title::after {
      content:attr(data-text);
      position:absolute;
      inset:0;
      background:var(--dark);
      clip:rect(0,9999px,0,0);
    }
    .title::before {
      left:5px;
      text-shadow:-7px 0 var(--pink);
      animation:glitch1 2.2s infinite alternate-reverse;
    }
    .title::after {
      left:-5px;
      text-shadow:7px 0 var(--cyan);
      animation:glitch2 3.3s infinite alternate-reverse;
    }

    @keyframes glitch  {
      0%,100%{transform:translate(0)}
      3%,7%,11%{transform:translate(6px,-5px)}
    }
    @keyframes glitch1 {
      0%{clip:rect(30px,9999px,60px,0)}
      50%{clip:rect(80px,9999px,120px,0)}
      100%{clip:rect(40px,9999px,80px,0)}
    }
    @keyframes glitch2 {
      0%{clip:rect(70px,9999px,110px,0)}
      50%{clip:rect(20px,9999px,60px,0)}
      100%{clip:rect(5px,9999px,45px,0)}
    }

    .btn {
      padding:22px 70px;
      font-size:2.2rem;
      margin:35px;
      border:4px solid var(--pink);
      background:transparent;
      color:var(--pink);
      cursor:pointer;
    }

    .player-card {
      background:rgba(30,0,60,0.8);
      border:3px solid var(--purple);
      padding:16px 32px;
      margin:12px;
      min-width:170px;
      text-align:center;
    }
    .player-card.dead {
      opacity:0.4;
      text-decoration:line-through;
    }
  </style>
</head>

<body>

<div id="startScreen" class="screen active">
  <h1 class="title" data-text="RUSSIAN ROULETTE">RUSSIAN ROULETTE</h1>
  <input id="playerName" placeholder="DEIN HANDLE / NICKNAME">
  <button class="btn" id="startBtn">START GAME</button>
</div>

<div id="mainMenu" class="screen">
  <h1 class="title" data-text="NIGHT CITY">NIGHT CITY</h1>
  <button class="btn" id="createLobbyBtn">CREATE LOBBY</button>
  <button class="btn" id="joinLobbyBtn">JOIN LOBBY</button>
</div>

<div id="lobbyScreen" class="screen">
  <h1 class="title" data-text="LOBBY">LOBBY</h1>
  <div id="lobbyCodeDisplay" style="font-size:4rem;margin:40px 0;"></div>
  <div id="lobbyPlayers" style="display:flex;flex-wrap:wrap;justify-content:center;"></div>
  <button class="btn" id="addKI">+ KI</button>
  <button class="btn" id="startGameBtn">START</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBa5w0hQ1v7Nowk-BvDgkGeNRNf1WJtDgw",
  authDomain: "rrweb-dc73f.firebaseapp.com",
  databaseURL: "https://rrweb-dc73f-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "rrweb-dc73f"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

let user=null;
let lobbyCode="";
let playerName="";
let myPlayerKey=null;
let gameRef=null;
let players=[];

auth.signInAnonymously();
auth.onAuthStateChanged(u=>user=u);

function show(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

document.getElementById("startBtn").onclick=()=>{
  playerName=document.getElementById("playerName").value.trim()||"Choom";
  show("mainMenu");
};

document.getElementById("createLobbyBtn").onclick=()=>{
  lobbyCode=Math.random().toString(36).slice(2,6).toUpperCase();
  show("lobbyScreen");
  document.getElementById("lobbyCodeDisplay").textContent=lobbyCode;
  joinLobby();
};

function joinLobby(){
  if(!user){setTimeout(joinLobby,200);return;}

  gameRef=db.ref("lobbies/"+lobbyCode);
  const playersRef=gameRef.child("players");

  const newRef=playersRef.push();
  myPlayerKey=newRef.key;

  newRef.set({
    name:playerName,
    uid:user.uid,
    alive:true,
    isKI:false
  });

  // Entfernt Spieler wenn Browser schlieÃŸt
  newRef.onDisconnect().remove();

  gameRef.on("value",snap=>{
    const val=snap.val()||{};
    players=Object.entries(val.players||{}).map(([k,v])=>({key:k,...v}));
    updateLobbyUI();
  });

  window.addEventListener("beforeunload",cleanupLobby);
}

function updateLobbyUI(){
  document.getElementById("lobbyPlayers").innerHTML=
  players.map(p=>
    `<div class="player-card ${p.alive?'':'dead'}">
     ${p.name}${p.isKI?' ðŸ¤–':''}
     </div>`
  ).join("");
}

document.getElementById("addKI").onclick=()=>{
  gameRef.child("players").push({
    name:"KI-"+Math.floor(Math.random()*99),
    uid:"ki"+Date.now(),
    alive:true,
    isKI:true
  });
};

// ðŸ”¥ Chat lÃ¶schen wenn keine echten Spieler mehr
function cleanupLobby(){
  if(!myPlayerKey)return;

  const playerRef=db.ref(`lobbies/${lobbyCode}/players/${myPlayerKey}`);
  playerRef.remove().then(()=>{
    checkCleanup();
  });
}

function checkCleanup(){
  db.ref(`lobbies/${lobbyCode}/players`).once("value")
  .then(snap=>{
    const data=snap.val()||{};
    const realPlayers=Object.values(data).filter(p=>!p.isKI);
    if(realPlayers.length===0){
      db.ref(`lobbies/${lobbyCode}/chat`).remove();
    }
  });
}
</script>

</body>
</html>
