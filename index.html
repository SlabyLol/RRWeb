<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Night City Roulette</title>

<style>
body{
margin:0;
background:#050010;
color:white;
font-family:Courier New;
text-align:center;
}

h1{
text-shadow:2px 2px #ff00ff,-2px -2px #00ffff;
}

button,input{
padding:10px 18px;
margin:5px;
background:black;
color:#00ffff;
border:2px solid #00ffff;
cursor:pointer;
}

button:disabled{
opacity:0.3;
cursor:not-allowed;
}

.hidden{display:none;}

.chat{
border:1px solid #00ffff;
height:120px;
overflow:auto;
margin:5px;
padding:5px;
}

#gameArea{
position:relative;
width:600px;
height:600px;
margin:20px auto;
}

#circle{
position:absolute;
inset:0;
border-radius:50%;
border:2px solid cyan;
}

.player{
position:absolute;
transform:translate(-50%,-50%);
}

.dead{
opacity:0.4;
text-decoration:line-through;
}

#arrow{
position:absolute;
width:0;
height:0;
border-left:15px solid transparent;
border-right:15px solid transparent;
border-bottom:30px solid yellow;
top:-15px;
left:50%;
transform-origin:center bottom;
transition:0.4s;
}
</style>
</head>

<body>

<div id="startScreen">
<h1>NIGHT CITY ROULETTE</h1>
<input id="nameInput" placeholder="Your name"><br>
<button id="enterBtn">ENTER</button>
</div>

<div id="menuScreen" class="hidden">
<h2>Create / Join</h2>
<input id="codeInput" placeholder="Lobby Code">
<button id="createBtn">Create Lobby</button>
<button id="joinBtn">Join Lobby</button>
</div>

<div id="lobbyScreen" class="hidden">
<h2 id="lobbyTitle"></h2>
<h3 id="lobbyCodeDisplay"></h3>

<div id="playerList"></div>

<button id="addAiBtn">Add AI</button>
<button id="startBtn">Start Game</button>
<button id="leaveBtn">Leave</button>

<h3>Lobby Chat</h3>
<div id="lobbyChat" class="chat"></div>
<input id="lobbyMsg">
<button id="sendLobbyMsg">Send</button>
</div>

<div id="gameScreen" class="hidden">
<h2 id="turnDisplay"></h2>

<div id="gameArea">
<div id="circle"></div>
<div id="arrow"></div>
</div>

<button id="spinBtn">Spin</button>
<button id="shootBtn">Shoot</button>
<button id="doubleBtn">Double Shoot</button>
<button id="giveUpBtn">Give Up</button>

<h3>Game Chat</h3>
<div id="gameChat" class="chat"></div>
<input id="gameMsg">
<button id="sendGameMsg">Send</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, set, update, remove, onValue, push } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig={
apiKey:"AIzaSyBa5w0hQ1v7Nowk-BvDgkGeNRNf1WJtDgw",
authDomain:"rrweb-dc73f.firebaseapp.com",
databaseURL:"https://rrweb-dc73f-default-rtdb.europe-west1.firebasedatabase.app",
projectId:"rrweb-dc73f"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

let name="";
let lobbyId="";
let players={};
let gameState=null;

const screens={
start:startScreen,
menu:menuScreen,
lobby:lobbyScreen,
game:gameScreen
};

function show(s){
Object.values(screens).forEach(x=>x.classList.add("hidden"));
s.classList.remove("hidden");
}

enterBtn.onclick=()=>{
name=nameInput.value||"Player"+Math.floor(Math.random()*100);
show(menuScreen);
};

function genCode(){
return Math.random().toString(36).substring(2,7).toUpperCase();
}

createBtn.onclick=()=>{
lobbyId=genCode();
set(ref(db,"lobbies/"+lobbyId),{
players:{[name]:{alive:true,isAI:false}},
game:{state:"lobby"}
});
openLobby();
};

joinBtn.onclick=()=>{
lobbyId=codeInput.value.trim().toUpperCase();
update(ref(db,"lobbies/"+lobbyId+"/players"),{
[name]:{alive:true,isAI:false}
});
openLobby();
};

function openLobby(){
show(lobbyScreen);
lobbyCodeDisplay.innerText="Lobby Code: "+lobbyId;
listenLobby();
}

function listenLobby(){
onValue(ref(db,"lobbies/"+lobbyId),(snap)=>{
if(!snap.exists()){show(menuScreen);return;}
const data=snap.val();
players=data.players||{};
gameState=data.game||{};
renderLobby();
if(gameState.state==="playing"){
startGame();
}
});
}

function renderLobby(){
playerList.innerHTML="";
for(let p in players){
playerList.innerHTML+="<div>"+p+(players[p].isAI?" (AI)":"")+"</div>";
}
}

addAiBtn.onclick=()=>{
update(ref(db,"lobbies/"+lobbyId+"/players"),{
["AI-"+Math.floor(Math.random()*999)]:{alive:true,isAI:true}
});
};

startBtn.onclick=()=>{
const names=Object.keys(players);
update(ref(db,"lobbies/"+lobbyId+"/game"),{
state:"playing",
bullet:Math.floor(Math.random()*6),
chamber:0,
turn:names[0]
});
};

leaveBtn.onclick=()=>{
remove(ref(db,"lobbies/"+lobbyId+"/players/"+name));
show(menuScreen);
};

function startGame(){
show(gameScreen);

onValue(ref(db,"lobbies/"+lobbyId+"/game"),(snap)=>{
gameState=snap.val();
renderGame();
});
}

function renderGame(){
if(!gameState)return;

turnDisplay.innerText="Turn: "+gameState.turn;

renderCircle();
updateButtons();
}

function renderCircle(){
gameArea.querySelectorAll(".player").forEach(e=>e.remove());

const names=Object.keys(players);
const r=230, cx=300, cy=300;

names.forEach((p,i)=>{
const angle=(i/names.length)*2*Math.PI;
const x=cx+r*Math.cos(angle);
const y=cy+r*Math.sin(angle);
let d=document.createElement("div");
d.className="player";
d.style.left=x+"px";
d.style.top=y+"px";
d.innerText=p;
if(!players[p].alive)d.classList.add("dead");
gameArea.appendChild(d);
});

let idx=names.indexOf(gameState.turn);
arrow.style.transform="rotate("+((idx/names.length)*360)+"deg)";
}

function updateButtons(){
let active=(gameState.turn===name);
spinBtn.disabled=!active;
shootBtn.disabled=!active;
doubleBtn.disabled=!active;
giveUpBtn.disabled=!active;
}

function nextTurn(){
let alive=Object.keys(players).filter(p=>players[p].alive);
let idx=alive.indexOf(gameState.turn);
let next=alive[(idx+1)%alive.length];
update(ref(db,"lobbies/"+lobbyId+"/game/turn"),next);
}

shootBtn.onclick=()=>shoot(1);
doubleBtn.onclick=()=>shoot(2);

function shoot(times){
if(gameState.turn!==name)return;

let chamber=(gameState.chamber+times)%6;

if(chamber===gameState.bullet){
update(ref(db,"lobbies/"+lobbyId+"/players/"+name+"/alive"),false);
}

update(ref(db,"lobbies/"+lobbyId+"/game/chamber"),chamber);
nextTurn();
}

giveUpBtn.onclick=()=>{
update(ref(db,"lobbies/"+lobbyId+"/players/"+name+"/alive"),false);
nextTurn();
};

sendLobbyMsg.onclick=()=>{
push(ref(db,"lobbies/"+lobbyId+"/lobbyChat"),{
sender:name,
msg:lobbyMsg.value
});
lobbyMsg.value="";
};

onValue(ref(db,"lobbies/"+lobbyId+"/lobbyChat"),snap=>{
lobbyChat.innerHTML="";
if(!snap.exists())return;
snap.forEach(s=>{
let d=s.val();
lobbyChat.innerHTML+=d.sender+": "+d.msg+"<br>";
});
});

sendGameMsg.onclick=()=>{
push(ref(db,"lobbies/"+lobbyId+"/gameChat"),{
sender:name,
msg:gameMsg.value
});
gameMsg.value="";
};

onValue(ref(db,"lobbies/"+lobbyId+"/gameChat"),snap=>{
gameChat.innerHTML="";
if(!snap.exists())return;
snap.forEach(s=>{
let d=s.val();
gameChat.innerHTML+=d.sender+": "+d.msg+"<br>";
});
});

</script>
</body>
</html>
