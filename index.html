<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>RR Test</title>
<style>
body{background:#111;color:white;font-family:monospace;text-align:center}
button{padding:10px;margin:5px}
#screen{margin-top:30px}
.player{border:1px solid #0ff;margin:5px;padding:5px}
#chatBox{height:120px;overflow-y:auto;border:1px solid #0ff;margin:10px}
</style>
</head>
<body>

<h1>Russian Roulette</h1>

<div id="start">
<input id="nameInput" placeholder="Name">
<button id="enterBtn">Enter</button>
</div>

<div id="menu" style="display:none">
<button id="createBtn">Create Public Lobby</button>
<input id="joinInput" placeholder="Code">
<button id="joinBtn">Join Lobby</button>
<div id="serverList"></div>
</div>

<div id="lobby" style="display:none">
<h2 id="lobbyCode"></h2>
<div id="players"></div>
<div id="chatBox"></div>
<input id="chatInput" placeholder="Chat">
<button id="sendBtn">Send</button>
<button id="leaveBtn">Leave</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

const firebaseConfig = {
  apiKey:"AIzaSyBa5w0hQ1v7Nowk-BvDgkGeNRNf1WJtDgw",
  authDomain:"rrweb-dc73f.firebaseapp.com",
  databaseURL:"https://rrweb-dc73f-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"rrweb-dc73f"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

let user, name, lobbyCode, playerKey;

signInAnonymously(auth);

onAuthStateChanged(auth, u=>{
  user = u;
  console.log("Signed in:", u.uid);
});

function show(id){
  document.getElementById("start").style.display="none";
  document.getElementById("menu").style.display="none";
  document.getElementById("lobby").style.display="none";
  document.getElementById(id).style.display="block";
}

document.getElementById("enterBtn").onclick=()=>{
  name = document.getElementById("nameInput").value || "Player";
  show("menu");
  loadServers();
};

document.getElementById("createBtn").onclick=()=>{
  lobbyCode = Math.random().toString(36).substring(2,6).toUpperCase();
  const lobbyRef = ref(db,"lobbies/"+lobbyCode);
  set(lobbyRef,{
    public:true
  });
  joinLobby(lobbyCode);
};

document.getElementById("joinBtn").onclick=()=>{
  const code = document.getElementById("joinInput").value.toUpperCase();
  if(code) joinLobby(code);
};

function loadServers(){
  onValue(ref(db,"lobbies"),snap=>{
    const data=snap.val();
    let html="";
    if(data){
      Object.keys(data).forEach(code=>{
        if(data[code].public){
          html += `<div>${code}</div>`;
        }
      });
    }
    document.getElementById("serverList").innerHTML=html;
  });
}

function joinLobby(code){
  lobbyCode = code;
  show("lobby");
  document.getElementById("lobbyCode").innerText="Code: "+code;

  const playerRef = push(ref(db,"lobbies/"+code+"/players"));
  playerKey = playerRef.key;
  set(playerRef,{
    name:name,
    uid:user.uid
  });

  onValue(ref(db,"lobbies/"+code+"/players"),snap=>{
    const data=snap.val();
    let html="";
    if(data){
      Object.values(data).forEach(p=>{
        html+=`<div class="player">${p.name}</div>`;
      });
    }
    document.getElementById("players").innerHTML=html;
  });

  onValue(ref(db,"lobbies/"+code+"/chat"),snap=>{
    const data=snap.val();
    let html="";
    if(data){
      Object.values(data).forEach(m=>{
        html+=`<div><b>${m.name}:</b> ${m.text}</div>`;
      });
    }
    document.getElementById("chatBox").innerHTML=html;
  });
}

document.getElementById("sendBtn").onclick=()=>{
  const text=document.getElementById("chatInput").value;
  if(!text) return;
  push(ref(db,"lobbies/"+lobbyCode+"/chat"),{
    name:name,
    text:text
  });
  document.getElementById("chatInput").value="";
};

document.getElementById("leaveBtn").onclick=()=>{
  remove(ref(db,"lobbies/"+lobbyCode+"/players/"+playerKey));
  show("menu");
};
</script>

</body>
</html>
