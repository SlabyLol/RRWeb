<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RUSSIAN ROULETTE Ã— NIGHT CITY</title>

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>

<style>
body{margin:0;background:#0a0015;color:white;font-family:Courier New,monospace}
.screen{display:none;position:absolute;inset:0;flex-direction:column;align-items:center;justify-content:center}
.active{display:flex}
.title{font-size:4rem;letter-spacing:8px;text-shadow:0 0 20px #00ffff,0 0 40px #ff0044}
button{padding:12px 25px;margin:10px;background:transparent;border:2px solid #ff0044;color:#ff0044;cursor:pointer}
button:hover{background:#ff0044;color:black}
.player{border:2px solid #c300ff;padding:8px 20px;margin:8px}
.dead{opacity:.4;text-decoration:line-through}
#chatBox{width:300px;height:120px;overflow-y:auto;border:2px solid #00ffff;margin-top:10px;padding:5px}
</style>
</head>
<body>

<div id="start" class="screen active">
<h1 class="title">NIGHT CITY</h1>
<input id="nameInput" placeholder="NAME">
<button onclick="enterMenu()">ENTER</button>
</div>

<div id="menu" class="screen">
<h2>SERVER LIST</h2>
<div id="serverList"></div>
<button onclick="createLobby(true)">CREATE PUBLIC</button>
<button onclick="createLobby(false)">CREATE PRIVATE</button>
<button onclick="joinPrivate()">JOIN PRIVATE</button>
</div>

<div id="lobby" class="screen">
<h1 class="title">LOBBY</h1>
<div id="codeDisplay"></div>
<div id="playerList"></div>
<select id="modifier">
<option value="6">6 CHAMBERS</option>
<option value="8">8 CHAMBERS</option>
<option value="double">DOUBLE BULLET</option>
</select>
<button id="startBtn">START GAME</button>
<button onclick="addKI()">+ KI</button>
<div id="chatBox"></div>
<input id="chatInput" placeholder="CHAT...">
<button onclick="sendChat()">SEND</button>
</div>

<div id="game" class="screen">
<h1 class="title">GAME</h1>
<div id="gamePlayers"></div>
<button onclick="shoot()">SHOOT</button>
<button onclick="spin()">SPIN</button>
</div>

<script>
const firebaseConfig={
apiKey:"AIza...",
authDomain:"rrweb-dc73f.firebaseapp.com",
databaseURL:"https://rrweb-dc73f-default-rtdb.europe-west1.firebasedatabase.app",
projectId:"rrweb-dc73f"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();
const auth=firebase.auth();

let user,name,lobbyCode,myKey,isHost=false,gameRef,players=[],gameState;

auth.signInAnonymously();
auth.onAuthStateChanged(u=>user=u);

function show(id){document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));document.getElementById(id).classList.add("active")}

function enterMenu(){
name=document.getElementById("nameInput").value||"Player";
show("menu");
loadServers();
}

function loadServers(){
db.ref("lobbies").on("value",snap=>{
let data=snap.val()||{};
let list="";
for(let code in data){
if(data[code].public) list+=`<div>${code} <button onclick="joinLobby('${code}')">JOIN</button></div>`;
}
document.getElementById("serverList").innerHTML=list;
});
}

function createLobby(pub){
lobbyCode=Math.random().toString(36).slice(2,6).toUpperCase();
isHost=true;
setupLobby(pub);
}

function joinPrivate(){
let code=prompt("CODE?");
if(code) joinLobby(code.toUpperCase());
}

function joinLobby(code){
lobbyCode=code;
setupLobby(false);
}

function setupLobby(pub){
show("lobby");
document.getElementById("codeDisplay").innerText="CODE: "+lobbyCode;
gameRef=db.ref("lobbies/"+lobbyCode);

if(isHost){
gameRef.set({public:pub,host:user.uid});
}

let pRef=gameRef.child("players").push();
myKey=pRef.key;

pRef.set({name,uid:user.uid,alive:true,isKI:false});
pRef.onDisconnect().remove();

gameRef.on("value",snap=>{
let data=snap.val();
if(!data)return;
players=Object.entries(data.players||{}).map(([k,v])=>({key:k,...v}));
gameState=data.gameState;
updateLobby();
updateGame();
updateChat(data.chat||{});
});
}

function updateLobby(){
document.getElementById("playerList").innerHTML=
players.map(p=>`<div class="player ${p.alive?'':'dead'}">${p.name}${p.isKI?' ðŸ¤–':''}</div>`).join("");
document.getElementById("startBtn").style.display=isHost?"inline":"none";
}

document.getElementById("startBtn").onclick=()=>{
let mod=document.getElementById("modifier").value;
let chambers=6;
let bullet=Math.floor(Math.random()*6);

if(mod==="8"){chambers=8;bullet=Math.floor(Math.random()*8)}
if(mod==="double"){bullet=[Math.floor(Math.random()*6),Math.floor(Math.random()*6)]}

gameRef.child("gameState").set({turn:0,chambers,bullet,pos:0});
show("game");
};

function updateGame(){
if(!gameState)return;
document.getElementById("gamePlayers").innerHTML=
players.map(p=>`<div class="player ${p.alive?'':'dead'}">${p.name}</div>`).join("");
}

function shoot(){
let turnPlayer=players[gameState.turn];
if(turnPlayer.uid!==user.uid)return;

let pos=gameState.pos+1;
let dead=false;

if(Array.isArray(gameState.bullet)){
if(gameState.bullet.includes(pos-1)) dead=true;
}else if(pos-1===gameState.bullet) dead=true;

if(dead){
gameRef.child("players/"+turnPlayer.key).update({alive:false});
}

nextTurn(pos);
}

function spin(){
gameRef.child("gameState/pos").set(Math.floor(Math.random()*gameState.chambers));
}

function nextTurn(pos){
gameRef.child("gameState").update({pos:pos%gameState.chambers});
gameRef.child("gameState/turn").transaction(t=>{
let n=(t+1)%players.length;
while(!players[n].alive){n=(n+1)%players.length}
return n;
});
}

function addKI(){
gameRef.child("players").push({name:"KI-"+Math.floor(Math.random()*100),uid:"ki"+Date.now(),alive:true,isKI:true});
}

function sendChat(){
let text=document.getElementById("chatInput").value;
if(!text)return;
gameRef.child("chat").push({name,text});
document.getElementById("chatInput").value="";
}

function updateChat(chat){
let box=document.getElementById("chatBox");
box.innerHTML=Object.values(chat).map(m=>`<div><b>${m.name}:</b> ${m.text}</div>`).join("");
}
</script>
</body>
</html>
