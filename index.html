<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RUSSIAN ROULETTE Ã— NIGHT CITY</title>
<style>
:root{--pink:#ff0044;--cyan:#00ffff;--purple:#c300ff;--dark:#0a0015;}
body{margin:0;height:100vh;background:var(--dark);color:#e8f0ff;font-family:'Courier New',monospace;overflow:hidden;}
.screen{position:absolute;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;z-index:10;padding:20px;}
.screen.active{display:flex;}
.title{font-size:clamp(5rem,15vw,12rem);font-weight:900;text-transform:uppercase;letter-spacing:0.5em;color:#fff;text-shadow:0 0 25px var(--cyan),0 0 70px var(--pink);}
.screen input, .screen button{padding:12px 20px;margin:5px;font-size:1.5rem;color:var(--pink);background:transparent;border:2px solid var(--pink);cursor:pointer;}
.screen button:hover{background:var(--pink);color:#000;}
.layout{display:flex;width:100%;max-width:1200px;margin-top:20px;}
.left{flex:1;}
.right{width:300px;border-left:2px solid var(--cyan);padding-left:10px;}
.player{border:1px solid var(--pink);margin:5px;padding:5px;}
.dead{opacity:0.3;text-decoration:line-through;}
#chatBox{height:150px;overflow-y:auto;border:1px solid var(--cyan);margin-top:10px;padding:5px;background:#0a0015;}
#gameScreen #gun{font-size:260px;transform:rotate(-15deg);filter:drop-shadow(0 0 80px var(--pink));cursor:pointer;transition:all 0.5s;}
#gameScreen #gun.shoot{transform:rotate(-15deg) translateY(-80px) scale(1.3);filter:drop-shadow(0 0 180px #ff0044) brightness(2);}
#status{text-align:center;margin:40px;font-size:2rem;}
#currentTurn{position:absolute;width:50px;height:50px;border:3px solid #ffff66;border-radius:50%;pointer-events:none;}
</style>
</head>
<body>

<!-- START SCREEN -->
<div id="startScreen" class="screen active">
<h1 class="title" data-text="RUSSIAN ROULETTE">RUSSIAN ROULETTE</h1>
<input id="nameInput" placeholder="DEIN HANDLE / NICKNAME" maxlength="16">
<button id="enterBtn">ENTER</button>
</div>

<!-- MENU SCREEN -->
<div id="menuScreen" class="screen">
<h1 class="title" data-text="NIGHT CITY">NIGHT CITY</h1>
<button id="createPublicBtn">CREATE PUBLIC</button>
<input id="privateCodeInput" placeholder="Private Code">
<button id="createPrivateBtn">CREATE PRIVATE</button>
<input id="joinLobbyInput" placeholder="Lobby ID">
<input id="joinCodeInput" placeholder="Code falls privat">
<button id="joinBtn">JOIN</button>
<h3>Public Servers</h3>
<div id="serverList"></div>
</div>

<!-- LOBBY SCREEN -->
<div id="lobbyScreen" class="screen">
<h1 class="title" data-text="LOBBY">LOBBY <span id="lobbyCodeDisplay">----</span></h1>
<div class="layout">
<div class="left">
<button id="leaveBtn">LEAVE</button>
<button id="addKiBtn">ADD KI</button>
<div id="chatBox"></div>
<input id="chatInput" placeholder="Nachricht">
<button id="sendBtn">SEND</button>
</div>
<div class="right">
<h3>PLAYERS</h3>
<div id="playerList"></div>
<button id="startGameBtn">START GAME</button>
</div>
</div>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen" class="screen">
<h1 class="title" data-text="GAME ON">GAME ON</h1>
<div id="currentTurnDisplay"></div>
<div id="gun">ðŸ”«</div>
<div id="status"></div>
<div class="layout">
<div class="right">
<h3>PLAYERS</h3>
<div id="gamePlayers"></div>
</div>
</div>
<button id="spinBtn">SPIN CHAMBER</button>
<button id="shootBtn">SHOOT Ã—1</button>
<button id="doubleShootBtn">SHOOT Ã—2</button>
<button id="giveUpBtn">GIVE UP</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, set, push, onValue, get, remove, onDisconnect, update, runTransaction } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

// --- Firebase ---
const firebaseConfig = {
apiKey: "AIzaSyBa5w0hQ1v7Nowk-BvDgkGeNRNf1WJtDgw",
authDomain: "rrweb-dc73f.firebaseapp.com",
databaseURL: "https://rrweb-dc73f-default-rtdb.europe-west1.firebasedatabase.app",
projectId: "rrweb-dc73f",
storageBucket: "rrweb-dc73f.appspot.com",
messagingSenderId: "247426843219",
appId: "1:247426843219:web:c466e97fd59ee160c9bca6"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

let currentUser=null, userReady=false, lobbyId=null, myKey=null, isHost=false, players=[], gameState=null;
let playerName="";

// --- Elements ---
const startScreen=document.getElementById('startScreen');
const menuScreen=document.getElementById('menuScreen');
const lobbyScreen=document.getElementById('lobbyScreen');
const gameScreen=document.getElementById('gameScreen');
const nameInput=document.getElementById('nameInput');
const enterBtn=document.getElementById('enterBtn');
const createPublicBtn=document.getElementById('createPublicBtn');
const createPrivateBtn=document.getElementById('createPrivateBtn');
const privateCodeInput=document.getElementById('privateCodeInput');
const joinLobbyInput=document.getElementById('joinLobbyInput');
const joinCodeInput=document.getElementById('joinCodeInput');
const joinBtn=document.getElementById('joinBtn');
const serverList=document.getElementById('serverList');
const lobbyCodeDisplay=document.getElementById('lobbyCodeDisplay');
const leaveBtn=document.getElementById('leaveBtn');
const addKiBtn=document.getElementById('addKiBtn');
const playerList=document.getElementById('playerList');
const chatBox=document.getElementById('chatBox');
const chatInput=document.getElementById('chatInput');
const sendBtn=document.getElementById('sendBtn');
const startGameBtn=document.getElementById('startGameBtn');

const currentTurnDisplay=document.getElementById('currentTurnDisplay');
const gun=document.getElementById('gun');
const statusDisplay=document.getElementById('status');
const gamePlayers=document.getElementById('gamePlayers');
const spinBtn=document.getElementById('spinBtn');
const shootBtn=document.getElementById('shootBtn');
const doubleShootBtn=document.getElementById('doubleShootBtn');
const giveUpBtn=document.getElementById('giveUpBtn');

// --- Auth ---
signInAnonymously(auth).catch(e=>console.error(e));
onAuthStateChanged(auth,u=>{ if(u){ currentUser=u; userReady=true; }});

// --- Screens ---
function showScreen(screen){ [startScreen,menuScreen,lobbyScreen,gameScreen].forEach(s=>s.classList.remove('active')); screen.classList.add('active'); }

// --- Start Name ---
enterBtn.onclick=()=>{ playerName=nameInput.value||"Choom"; showScreen(menuScreen); loadPublicServers(); };

// --- Lobby Helpers ---
function generateLobbyID(){ return Math.random().toString(36).substring(2,6).toUpperCase(); }

async function createLobby(isPublic, code=null){
if(!userReady){ alert("Auth noch nicht fertig"); return; }
lobbyId=generateLobbyID(); isHost=true;
await set(ref(db,"lobbies/"+lobbyId),{public:isPublic,privateCode:code||null,hostUid:currentUser.uid,createdAt:Date.now()});
joinLobby(lobbyId);
}
createPublicBtn.onclick=()=>createLobby(true);
createPrivateBtn.onclick=()=>createLobby(false,privateCodeInput.value.trim());

async function joinLobby(id){
const snap=await get(ref(db,"lobbies/"+id));
if(!snap.exists()){ alert("Lobby nicht gefunden"); return; }
const data=snap.val();
if(!data.public && joinCodeInput.value!==data.privateCode){ alert("Falscher Code"); return; }
lobbyId=id; isHost=(data.hostUid===currentUser.uid);
const pRef=push(ref(db,"lobbies/"+lobbyId+"/players"));
myKey=pRef.key; set(pRef,{name:playerName,uid:currentUser.uid,isKI:false});
onDisconnect(pRef).remove();
listenLobby();
showScreen(lobbyScreen);
}
joinBtn.onclick=()=>joinLobby(joinLobbyInput.value.toUpperCase());

function listenLobby(){
onValue(ref(db,"lobbies/"+lobbyId),snap=>{
const data=snap.val();
if(!data){ showScreen(menuScreen); return; }
lobbyCodeDisplay.textContent=lobbyId;
renderPlayers(data.players||{});
renderChat(data.chat||{});
// delete lobby if no human
let humanCount=0;
for(let k in data.players) if(!data.players[k].isKI) humanCount++;
if(isHost && humanCount===0) remove(ref(db,"lobbies/"+lobbyId));
});
}

function renderPlayers(playersObj){
players=[]; let html="";
for(let k in playersObj){ const p=playersObj[k]; players.push({key:k,...p}); html+=`<div class="player">${p.name}${p.isKI?" ðŸ¤–":""}</div>\n`; }
playerList.innerHTML=html;
}

function renderChat(chatObj){
let html=""; for(let k in chatObj) html+=`<div><b>${chatObj[k].name}:</b> ${chatObj[k].text}</div>`;
chatBox.innerHTML=html;
}

addKiBtn.onclick=()=>push(ref(db,"lobbies/"+lobbyId+"/players"),{name:"KI-"+Math.floor(Math.random()*100),uid:"KI"+Date.now(),isKI:true});
leaveBtn.onclick=()=>{ if(myKey) remove(ref(db,"lobbies/"+lobbyId+"/players/"+myKey)); showScreen(menuScreen); loadPublicServers(); };
sendBtn.onclick=()=>{ if(chatInput.value) push(ref(db,"lobbies/"+lobbyId+"/chat"),{name:playerName,text:chatInput.value}); chatInput.value=""; };

function loadPublicServers(){
onValue(ref(db,"lobbies"),snap=>{
const data=snap.val(); let html="";
if(data) for(let id in data) if(data[id].public) html+=`<div>${id}</div>`;
serverList.innerHTML=html;
}

}
</script>

</body>
</html>
