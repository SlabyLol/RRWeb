<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RUSSIAN ROULETTE Ã— NIGHT CITY</title>
<style>
body{margin:0;background:#0a0015;color:white;font-family:Courier New,monospace;overflow:hidden}
.screen{display:none;position:absolute;inset:0;flex-direction:column;align-items:center;justify-content:center;padding:20px;}
.active{display:flex}
.title{font-size:6vw;letter-spacing:8px;text-shadow:0 0 20px #00ffff,0 0 50px #ff0044;animation:glitch 3s infinite}
@keyframes glitch{0%{transform:translate(0)}10%{transform:translate(3px,-3px)}20%{transform:translate(-3px,3px)}30%{transform:translate(0)}}
button{padding:12px 25px;margin:10px;background:transparent;border:2px solid #ff0044;color:#ff0044;cursor:pointer}
button:hover{background:#ff0044;color:black}
.playerCard{padding:8px 12px;margin:5px;border:2px solid #c300ff;border-radius:6px;text-align:center;display:inline-block;min-width:80px;}
.dead{opacity:0.4;text-decoration:line-through}
#playersCircle{position:relative;width:400px;height:400px;margin:20px;}
.currentArrow{position:absolute;width:0;height:0;border-left:15px solid transparent;border-right:15px solid transparent;border-bottom:25px solid #ffff66;transform-origin:center bottom;transition:transform 0.5s;}
#chatBox, #chatBoxGame{width:300px;height:150px;overflow-y:auto;border:2px solid #00ffff;margin-top:10px;padding:5px}
#chatInput, #chatInputGame{width:240px;padding:5px;margin-top:5px}
#particles{position:fixed;inset:0;pointer-events:none;z-index:5}
#winnerText{position:absolute;top:40%;font-size:4rem;color:#ffff66;text-shadow:0 0 20px #ffff66;display:none;animation:pulse 1s infinite alternate;}
@keyframes pulse{0%{transform:scale(1)}100%{transform:scale(1.2)}}
</style>
</head>
<body>

<!-- START -->
<div id="start" class="screen active">
<h1 class="title">NIGHT CITY</h1>
<input id="nameInput" placeholder="NAME">
<button onclick="enterMenu()">ENTER</button>
</div>

<!-- MENU -->
<div id="menu" class="screen">
<h2>SERVER LIST</h2>
<div id="serverList"></div>
<button onclick="createLobby(true)">CREATE PUBLIC</button>
<button onclick="createLobby(false)">CREATE PRIVATE</button>
<button onclick="joinPrivate()">JOIN PRIVATE</button>
</div>

<!-- LOBBY -->
<div id="lobby" class="screen">
<h1 class="title">LOBBY</h1>
<div id="codeDisplay"></div>
<div id="playerList"></div>
<select id="modifier">
<option value="6">6 CHAMBERS</option>
<option value="8">8 CHAMBERS</option>
<option value="double">DOUBLE BULLET</option>
</select>
<button id="startBtn">START GAME</button>
<button onclick="addKI()">+ KI</button>
<button onclick="leaveLobby()">LEAVE</button>
<div id="chatBox"></div>
<input id="chatInput" placeholder="CHAT...">
<button onclick="sendChat()">SEND</button>
</div>

<!-- GAME -->
<div id="game" class="screen">
<h1 class="title">GAME</h1>
<div id="playersCircle"></div>
<div class="currentArrow" id="currentArrow"></div>
<div id="gameButtons">
<button onclick="shoot()">SHOOT</button>
<button onclick="spin()">SPIN</button>
<button onclick="giveUp()">GIVE UP</button>
<button onclick="leaveLobby()">LEAVE</button>
</div>
<div id="chatBoxGame"></div>
<input id="chatInputGame" placeholder="CHAT...">
<button onclick="sendChatGame()">SEND</button>
<div id="winnerText"></div>
<div id="particles"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, onValue, push, set, update, remove, runTransaction } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

// --- Firebase Config ---
const firebaseConfig = {
  apiKey:"AIzaSyBa5w0hQ1v7Nowk-BvDgkGeNRNf1WJtDgw",
  authDomain:"rrweb-dc73f.firebaseapp.com",
  databaseURL:"https://rrweb-dc73f-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"rrweb-dc73f"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth();

let user,name,lobbyCode,myKey,isHost=false,gameRef,players=[],gameState={};

signInAnonymously(auth);
onAuthStateChanged(auth,u=>user=u);

function show(id){document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));document.getElementById(id).classList.add("active")}
function enterMenu(){name=document.getElementById("nameInput").value||"Player";show("menu");loadServers();}

// --- Load Public Lobbies ---
function loadServers(){
  const lobbiesRef = ref(db,"lobbies");
  onValue(lobbiesRef,snap=>{
    let data=snap.val()||{};
    let list="";
    for(let code in data){
      if(data[code].public && data[code].players && Object.keys(data[code].players).length>0){
        list+=`<div>${code} <button onclick="joinLobby('${code}')">JOIN</button></div>`;
      }
    }
    document.getElementById("serverList").innerHTML=list;
  });
}

// --- Lobby ---
function createLobby(pub){lobbyCode=Math.random().toString(36).slice(2,6).toUpperCase(); isHost=true; setupLobby(pub);}
function joinPrivate(){let code=prompt("CODE?"); if(code) joinLobby(code.toUpperCase());}
function joinLobby(code){lobbyCode=code; setupLobby(false);}
function setupLobby(pub){
  show("lobby");
  document.getElementById("codeDisplay").innerText="CODE: "+lobbyCode;
  gameRef = ref(db,"lobbies/"+lobbyCode);
  if(isHost) update(gameRef,{public:pub,hostUid:user.uid,players:{},chat:{}});
  const pRef = push(ref(db,"lobbies/"+lobbyCode+"/players")); myKey=pRef.key;
  set(pRef,{name,uid:user.uid,alive:true,isKI:false});
  pRef.onDisconnect().remove();
  onValue(gameRef,snap=>{
    const data=snap.val(); if(!data) return;
    players=Object.entries(data.players||{}).map(([k,v])=>({key:k,...v}));
    gameState=data.gameState||{};
    updateLobby();
    updateGame();
    updateChat(data.chat||{},true);
    if(isHost){const humans=players.filter(p=>!p.isKI); if(humans.length===0){remove(gameRef); show("menu");}}
  });
}
function updateLobby(){document.getElementById("playerList").innerHTML=players.map(p=>`<div class="playerCard ${p.alive?'':'dead'}">${p.name}${p.isKI?' ðŸ¤–':''}</div>`).join(""); document.getElementById("startBtn").style.display=isHost?"inline":"none";}

// --- Start Game ---
document.getElementById("startBtn").onclick=()=>{
  let mod=document.getElementById("modifier").value;
  let chambers=6, bullet=Math.floor(Math.random()*6);
  if(mod==="8"){chambers=8; bullet=Math.floor(Math.random()*8);}
  if(mod==="double"){bullet=[Math.floor(Math.random()*6),Math.floor(Math.random()*6)];}
  update(ref(db,"lobbies/"+lobbyCode+"/gameState"),{turn:0,chambers,bullet,pos:0});
  show("game");
};

// --- Game Update mit Kreis ---
function updateGame(){
  const circle = document.getElementById("playersCircle");
  circle.innerHTML="";
  const n = players.length;
  const radius = 150;
  const center = radius;
  players.forEach((p,i)=>{
    const angle = (2*Math.PI*i/n) - Math.PI/2;
    const x = center + radius * Math.cos(angle);
    const y = center + radius * Math.sin(angle);
    const div = document.createElement("div");
    div.className = "playerCard" + (p.alive?"":" dead");
    div.style.position = "absolute";
    div.style.left = x+"px";
    div.style.top = y+"px";
    div.style.transform = "translate(-50%, -50%)";
    div.innerText = p.name;
    circle.appendChild(div);
  });
  // Pfeil auf aktuellen Spieler
  const arrow = document.getElementById("currentArrow");
  if(gameState.turn!=null && players[gameState.turn]){
    let angle = (360/n)*gameState.turn - 90;
    arrow.style.transform=`rotate(${angle}deg) translate(180px)`;
  }
  // KI automatisch
  let current=players[gameState.turn]; if(current?.isKI && current.alive){setTimeout(()=>shoot(),1500);}
}

// --- Shoot / GiveUp / Spin ---
function shoot(){let turnPlayer=players[gameState.turn]; if(!turnPlayer) return;if(turnPlayer.uid!==user.uid && !turnPlayer.isKI) return;
let pos=(gameState.pos||0)+1, dead=false;
if(Array.isArray(gameState.bullet)){if(gameState.bullet.includes(pos-1)) dead=true;} else if(pos-1===gameState.bullet) dead=true;
if(dead){update(ref(db,"lobbies/"+lobbyCode+"/players/"+turnPlayer.key),{alive:false}); createBangParticles();}
nextTurn(pos); checkWinner();}
function giveUp(){let turnPlayer=players[gameState.turn]; if(!turnPlayer) return; update(ref(db,"lobbies/"+lobbyCode+"/players/"+turnPlayer.key),{alive:false}); nextTurn(gameState.pos||0); checkWinner();}
function spin(){update(ref(db,"lobbies/"+lobbyCode+"/gameState"),{pos:Math.floor(Math.random()*(gameState.chambers||6))});}
function nextTurn(pos){update(ref(db,"lobbies/"+lobbyCode+"/gameState"),{pos:pos%(gameState.chambers||6)}); runTransaction(ref(db,"lobbies/"+lobbyCode+"/gameState/turn"),t=>{let n=(t+1)%players.length,s=0;while(!players[n].alive && s<players.length){n=(n+1)%players.length;s++} return n;});}

// --- KI ---
function addKI(){push(ref(db,"lobbies/"+lobbyCode+"/players"),{name:"KI-"+Math.floor(Math.random()*100),uid:"ki"+Date.now(),alive:true,isKI:true});}

// --- Chat ---
function sendChat(){let txt=document.getElementById("chatInput").value;if(!txt)return;push(ref(db,"lobbies/"+lobbyCode+"/chat"),{name:name,text:txt});document.getElementById("chatInput").value="";}
function sendChatGame(){let txt=document.getElementById("chatInputGame").value;if(!txt)return;push(ref(db,"lobbies/"+lobbyCode+"/chat"),{name:name,text:txt});document.getElementById("chatInputGame").value="";}
function updateChat(chat,lobby=false){let box=lobby?document.getElementById("chatBox"):document.getElementById("chatBoxGame");box.innerHTML=Object.values(chat).map(m=>`<div><b>${m.name}:</b> ${m.text}</div>`).join("");}

// --- Leave / Partikel / Winner ---
function leaveLobby(){if(myKey) remove(ref(db,"lobbies/"+lobbyCode+"/players/"+myKey)); show("menu"); isHost=false;}
function createBangParticles(){const c=document.getElementById("particles");for(let i=0;i<50;i++){const p=document.createElement('div');p.style.cssText=`position:absolute;width:8px;height:8px;border-radius:50%;background:#ff0044;left:50%;top:50%;transform:translate(-50%,-50%);animation:fly ${0.6+Math.random()}s forwards`;c.appendChild(p);setTimeout(()=>p.remove(),1800);}}
function checkWinner(){let alive=players.filter(p=>p.alive); if(alive.length===1){let txt=document.getElementById("winnerText"); txt.innerText=`WINNER: ${alive[0].name}`; txt.style.display="block"; setTimeout(()=>location.reload(),4000);}}
</script>

</body>
</html>
