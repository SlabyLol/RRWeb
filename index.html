<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RUSSIAN ROULETTE Ã— NIGHT CITY</title>

  <script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, update, transaction, push, get } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBa5w0hQ1v7Nowk-BvDgkGeNRNf1WJtDgw",
      authDomain: "rrweb-dc73f.firebaseapp.com",
      projectId: "rrweb-dc73f",
      storageBucket: "rrweb-dc73f.firebasestorage.app",
      messagingSenderId: "247426843219",
      appId: "1:247426843219:web:c466e97fd59ee160c9bca6",
      databaseURL: "https://rrweb-dc73f-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let user = null;
    let playerName = localStorage.getItem('rr_handle') || '';
    let lobbyCode = '';
    let isHost = false;
    let myPlayerKey = null;
    let gameRef = null;
    let players = [];
    let gameState = { started: false, bulletPos: -1, currentPos: 0, currentTurn: 0, chambers: 6 };

    // Auth initialisieren
    signInAnonymously(auth).catch(err => console.error("Login Fehler:", err));

    onAuthStateChanged(auth, u => {
      user = u;
      console.log("Auth ready:", user ? user.uid : "noch nicht");
    });

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function createBangParticles() {
      const c = document.getElementById('particles');
      for (let i = 0; i < 60; i++) {
        const p = document.createElement('div');
        p.style.cssText = `position:absolute;width:8px;height:8px;border-radius:50%;background:#ff2a8c;left:50%;top:40%;pointer-events:none;transform:translate(-50%,-50%);animation:fly ${0.6+Math.random()}s forwards;`;
        c.appendChild(p);
        setTimeout(()=>p.remove(), 1600);
      }
    }

    // â”€â”€â”€ START SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const nameInput  = document.getElementById('playerName');
    const startBtn   = document.getElementById('startButton');
    const gunClick   = document.getElementById('gunClick');

    if (playerName) nameInput.value = playerName;

    function goToLobby() {
      playerName = nameInput.value.trim() || `Anon-${Math.floor(Math.random()*9999)}`;
      localStorage.setItem('rr_handle', playerName);
      console.log("â†’ Lobby mit:", playerName);
      showScreen('lobbyScreen');
      document.getElementById('lobbyPlayerName').textContent = playerName;
    }

    // Events â€“ robust & verhindert Doppel-AusfÃ¼hrung
    nameInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        goToLobby();
      }
    });

    startBtn.addEventListener('click', e => {
      e.preventDefault();
      goToLobby();
    });

    gunClick.addEventListener('click', goToLobby);

    gunClick.addEventListener('mouseenter', () => gunClick.style.animationDuration = '2.2s');
    gunClick.addEventListener('mouseleave', () => gunClick.style.animationDuration = '5.5s');

    // â”€â”€â”€ LOBBY & SPIEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // (Rest deines Codes â€“ nur die kritischen Stellen angepasst)

    document.getElementById('createLobby').onclick = () => {
      lobbyCode = Math.random().toString(36).slice(2,6).toUpperCase();
      document.getElementById('lobbyCodeDisplay').textContent = lobbyCode;
      isHost = true;
      joinLobby();
    };

    document.getElementById('joinLobbyBtn').onclick = () => {
      const code = document.getElementById('joinCodeInput').value.trim().toUpperCase();
      if (code.length !== 4) return alert('4 Zeichen Code!');
      lobbyCode = code;
      document.getElementById('lobbyCodeDisplay').textContent = lobbyCode;
      joinLobby();
    };

    function joinLobby() {
      if (!user) {
        console.log("Warte auf Auth...");
        setTimeout(joinLobby, 600);
        return;
      }

      gameRef = ref(db, `lobbies/${lobbyCode}`);
      const playersRef = ref(db, `lobbies/${lobbyCode}/players`);

      get(playersRef).then(snap => {
        const data = snap.val() || {};
        if (!Object.values(data).some(p => p.uid === user.uid)) {
          const newRef = push(playersRef);
          myPlayerKey = newRef.key;
          set(newRef, { name: playerName, uid: user.uid, alive: true, isKI: false });
        }

        onValue(gameRef, snap => {
          const val = snap.val() || {};
          players = Object.entries(val.players || {}).map(([k,v]) => ({key:k, ...v}));
          gameState = {...gameState, ...(val.gameState || {})};
          updateUI();
        });
      }).catch(e => console.error("Join Fehler:", e));
    }

    function updateUI() {
      document.getElementById('lobbyPlayers').innerHTML = players.map(p => `
        <div class="player-card">${p.name}${p.isKI ? ' (KI)' : ''}</div>
      `).join('');

      document.getElementById('startGame').disabled = !isHost || players.length < 2;

      if (gameState.started) {
        showScreen('gameScreen');
        updateGameUI();
      }
    }

    // â”€â”€â”€ Game-Logik (gekÃ¼rzt â€“ erweitere bei Bedarf) â”€â”€â”€â”€â”€â”€â”€
    function updateGameUI() {
      // Deine volle Update-Logik hier...
      console.log("Game UI update");
    }

    // Weitere Funktionen (shoot, spin, etc.) aus frÃ¼heren Versionen einfÃ¼gen
  </script>

  <style>
    body { margin:0; height:100vh; background:#0a0012; color:#e0f8ff; font-family:'Courier New',monospace; overflow:hidden; }
    .screen { position:absolute; inset:0; display:none; flex-direction:column; align-items:center; justify-content:center; z-index:10; }
    .screen.active { display:flex; }

    .title { font-size: clamp(5rem, 14vw, 10rem); color:#fff; text-shadow:0 0 30px #00faff, 0 0 60px #ff2a8c; animation:glitch 4s infinite; }
    @keyframes glitch { 0%,100%{transform:translate(0)} 2%,6%{transform:translate(3px,-3px)} }

    .gun { font-size:clamp(12rem, 30vw, 22rem); filter:drop-shadow(0 0 80px #ff2a8c); animation:pulse 5s infinite; cursor:pointer; }
    @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.04)} }

    input, button { padding:18px 50px; font-size:1.8rem; margin:30px; border:3px solid #00faff; background:transparent; color:#00faff; box-shadow:0 0 40px rgba(0,250,255,0.5); cursor:pointer; }
    button:hover { background:#00faff; color:#000; box-shadow:0 0 80px #00faff; transform:translateY(-4px); }
  </style>
</head>
<body>

<div id="startScreen" class="screen active">
  <h1 class="title">RUSSIAN ROULETTE</h1>
  <div class="gun" id="gunClick">ðŸ”«</div>
  <input id="playerName" placeholder="DEIN HANDLE" maxlength="16" autofocus>
  <button id="startButton">START GAME</button>
</div>

<div id="lobbyScreen" class="screen">
  <h1>LOBBY</h1>
  <div id="lobbyCodeDisplay">----</div>
  <div>Handle: <span id="lobbyPlayerName"></span></div>
  <div id="lobbyPlayers"></div>
  <button id="createLobby">CREATE</button>
  <button id="joinLobbyBtn">JOIN</button>
  <input id="joinCodeInput" maxlength="4" placeholder="CODE">
  <button id="startGame" disabled>START</button>
</div>

<!-- gameScreen hier einfÃ¼gen -->

<div id="particles"></div>

</body>
</html>
