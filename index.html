<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RUSSIAN ROULETTE Ã— NIGHT CITY</title>

  <!-- Firebase Compat (sehr stabil) -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>

  <style>
    :root {
      --pink: #ff0044;
      --cyan: #00ffff;
      --purple: #c300ff;
      --dark: #0a0015;
    }
    body {
      margin:0; height:100vh; background:var(--dark); color:#e8f0ff; font-family:'Courier New',monospace; overflow:hidden;
    }
    .screen { position:absolute; inset:0; display:none; flex-direction:column; align-items:center; justify-content:center; z-index:10; padding:20px; }
    .screen.active { display:flex; }

    .title {
      font-size: clamp(5rem, 15vw, 12rem);
      font-weight:900; text-transform:uppercase; letter-spacing:0.5em;
      color:#fff; text-shadow:0 0 25px var(--cyan), 0 0 70px var(--pink);
      position:relative; animation:glitch 5s infinite;
    }
    .title::before, .title::after { content:attr(data-text); position:absolute; inset:0; background:var(--dark); clip:rect(0,9999px,0,0); }
    .title::before { left:5px; text-shadow:-7px 0 var(--pink); animation:glitch1 2.2s infinite alternate-reverse; }
    .title::after  { left:-5px; text-shadow:7px 0 var(--cyan);  animation:glitch2 3.3s infinite alternate-reverse; }

    @keyframes glitch  { 0%,100%{transform:translate(0)} 3%,7%,11%{transform:translate(6px,-5px)} }
    @keyframes glitch1 { 0%{clip:rect(30px,9999px,60px,0)} 20%{clip:rect(80px,9999px,120px,0)} 40%{clip:rect(10px,9999px,50px,0)} 60%{clip:rect(90px,9999px,140px,0)} 100%{clip:rect(40px,9999px,80px,0)} }
    @keyframes glitch2 { 0%{clip:rect(70px,9999px,110px,0)} 25%{clip:rect(20px,9999px,60px,0)} 50%{clip:rect(100px,9999px,150px,0)} 75%{clip:rect(50px,9999px,90px,0)} 100%{clip:rect(5px,9999px,45px,0)} }

    .gun-intro { font-size:clamp(14rem,40vw,32rem); filter:drop-shadow(0 0 100px var(--pink)); animation:breath 5.5s ease-in-out infinite; cursor:pointer; margin:60px 0; }
    @keyframes breath { 0%,100%{transform:scale(1) rotate(-15deg)} 50%{transform:scale(1.08) rotate(15deg)} }

    input, .btn {
      padding:22px 70px; font-size:2.2rem; margin:35px; border:4px solid var(--cyan); background:transparent; color:var(--cyan);
      box-shadow:0 0 60px rgba(0,255,255,0.6); cursor:pointer; transition:all 0.4s;
    }
    .btn { border-color:var(--pink); color:var(--pink); box-shadow:0 0 70px rgba(255,0,68,0.7); }
    .btn:hover { background:var(--pink); color:#000; box-shadow:0 0 140px var(--pink); transform:translateY(-8px); }

    .player-card {
      background:rgba(30,0,60,0.8); border:3px solid var(--purple); padding:16px 32px; margin:12px; min-width:170px;
      text-align:center; box-shadow:0 0 35px rgba(195,0,255,0.6); transition:all 0.3s;
    }
    .player-card.current { border-color:#ffff66; box-shadow:0 0 60px #ffff66; animation:pulse 1.4s infinite; }
    .player-card.dead { opacity:0.5; text-decoration:line-through; }
    .player-card.ki { border-color:var(--cyan); }

    #gun { font-size:260px; transform:rotate(-15deg); filter:drop-shadow(0 0 80px var(--pink)); transition:all 0.5s; cursor:pointer; }
    #gun.shoot { transform:rotate(-15deg) translateY(-80px) scale(1.3); filter:drop-shadow(0 0 180px #ff0044) brightness(2); }

    #status { font-size:2.8rem; margin:70px 0; text-shadow:0 0 40px currentColor; min-height:100px; text-align:center; }

    #particles { position:fixed; inset:0; pointer-events:none; z-index:5; }

    @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.07)} }
  </style>
</head>
<body>

<div id="particles"></div>

<!-- START SCREEN -->
<div id="startScreen" class="screen active">
  <h1 class="title" data-text="RUSSIAN ROULETTE">RUSSIAN ROULETTE</h1>
  <div class="gun-intro" id="gunIntro">ðŸ”«</div>
  <input id="playerName" placeholder="DEIN HANDLE / NICKNAME" maxlength="16" autofocus>
  <button class="btn" id="startBtn">START GAME</button>
</div>

<!-- MAIN MENU -->
<div id="mainMenu" class="screen">
  <h1 class="title" data-text="NIGHT CITY">NIGHT CITY</h1>
  <button class="btn" id="createLobbyBtn">CREATE LOBBY</button>
  <button class="btn" id="joinLobbyBtn">JOIN LOBBY</button>
</div>

<!-- LOBBY SCREEN -->
<div id="lobbyScreen" class="screen">
  <h1 class="title" data-text="LOBBY">LOBBY</h1>
  <div id="lobbyCodeDisplay" style="font-size:7rem; color:var(--pink); letter-spacing:15px; margin:50px 0;">----</div>
  <div id="hostBadge" style="color:var(--cyan); font-size:2.8rem; display:none; margin-bottom:40px;">YOU ARE HOST</div>
  <div style="font-size:2.4rem; margin:40px 0;">Handle: <span id="lobbyPlayerName"></span></div>
  <div id="lobbyPlayers" style="display:flex; flex-wrap:wrap; justify-content:center; max-width:95%; gap:25px;"></div>
  <div style="margin-top:60px; display:flex; gap:30px; flex-wrap:wrap; justify-content:center;">
    <button class="btn" id="addKI">+ KI-SPIELER</button>
    <button class="btn" id="startGameBtn">START GAME</button>
  </div>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen" class="screen">
  <h1 class="title" data-text="GAME ON">GAME ON</h1>
  <div id="currentTurnDisplay" style="font-size:4rem; color:#ffff66; margin:50px 0; text-shadow:0 0 50px #ffff66;">Dran: ...</div>
  <div style="position:relative; margin:60px 0;">
    <div id="gun">ðŸ”«</div>
  </div>
  <div id="status" style="color:var(--cyan); font-size:3rem; text-shadow:0 0 40px var(--cyan);">Warte auf Start...</div>
  <div id="gamePlayers" style="display:flex; flex-wrap:wrap; justify-content:center; max-width:95%; gap:25px; margin:60px 0;"></div>
  <div style="margin-top:70px; display:flex; flex-wrap:wrap; gap:35px; justify-content:center;">
    <button class="btn" id="spin">SPIN CHAMBER</button>
    <button class="btn" id="shoot">SHOOT Ã—1</button>
    <button class="btn" id="doubleShoot">SHOOT Ã—2 âš¡</button>
    <button class="btn" id="giveUp" style="border-color:#ff4444; color:#ff6666; box-shadow:0 0 60px #ff4444;">GIVE UP</button>
  </div>
</div>

<script>
// Firebase Config & Init
const firebaseConfig = {
  apiKey: "AIzaSyBa5w0hQ1v7Nowk-BvDgkGeNRNf1WJtDgw",
  authDomain: "rrweb-dc73f.firebaseapp.com",
  databaseURL: "https://rrweb-dc73f-default-rtdb.firebaseio.com",
  projectId: "rrweb-dc73f",
  storageBucket: "rrweb-dc73f.appspot.com",
  messagingSenderId: "247426843219",
  appId: "1:247426843219:web:c466e97fd59ee160c9bca6"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

let user = null;
let playerName = localStorage.getItem('rr_nickname') || '';
let lobbyCode = '';
let isHost = false;
let myPlayerKey = null;
let gameRef = null;
let players = [];
let gameState = { started: false, bulletPos: -1, currentPos: 0, currentTurn: 0, chambers: 6 };

auth.signInAnonymously().catch(e => console.error(e));
auth.onAuthStateChanged(u => { user = u; });

// Screen-Wechsel
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// Particles bei BANG
function createBangParticles() {
  const c = document.getElementById('particles');
  for (let i = 0; i < 70; i++) {
    const p = document.createElement('div');
    p.style.cssText = `position:absolute;width:7px;height:7px;border-radius:50%;background:#ff0044;left:50%;top:40%;pointer-events:none;transform:translate(-50%,-50%);animation:fly ${0.6+Math.random()*1.1}s forwards;`;
    c.appendChild(p);
    setTimeout(()=>p.remove(), 1800);
  }
}

// â”€â”€â”€ START SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const nameInput = document.getElementById('playerName');
const startBtn  = document.getElementById('startBtn');
const gunIntro  = document.getElementById('gunIntro');

function goToMainMenu() {
  playerName = nameInput.value.trim() || `Choom-${Math.floor(Math.random()*9999)}`;
  localStorage.setItem('rr_nickname', playerName);
  showScreen('mainMenu');
}

nameInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') goToMainMenu();
});

startBtn.addEventListener('click', goToMainMenu);

gunIntro.addEventListener('click', goToMainMenu);

// â”€â”€â”€ MAIN MENU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('createLobbyBtn').onclick = () => {
  lobbyCode = Math.random().toString(36).slice(2,6).toUpperCase();
  document.getElementById('lobbyCodeDisplay').textContent = lobbyCode;
  document.getElementById('hostBadge').style.display = 'block';
  isHost = true;
  showScreen('lobbyScreen');
  joinOrCreateLobby();
};

document.getElementById('joinLobbyBtn').onclick = () => {
  const code = prompt("Lobby-Code (4 Zeichen):")?.trim().toUpperCase();
  if (code && code.length === 4) {
    lobbyCode = code;
    document.getElementById('lobbyCodeDisplay').textContent = lobbyCode;
    isHost = false;
    showScreen('lobbyScreen');
    joinOrCreateLobby();
  }
};

// â”€â”€â”€ LOBBY LOGIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function joinOrCreateLobby() {
  if (!user) return setTimeout(joinOrCreateLobby, 500);

  gameRef = db.ref(`lobbies/${lobbyCode}`);
  const playersRef = gameRef.child('players');

  playersRef.once('value').then(snap => {
    const data = snap.val() || {};
    if (!Object.values(data).some(p => p.uid === user.uid)) {
      const newRef = playersRef.push();
      myPlayerKey = newRef.key;
      newRef.set({
        name: playerName,
        uid: user.uid,
        alive: true,
        isKI: false
      });
    }

    gameRef.on('value', snap => {
      const val = snap.val() || {};
      players = Object.entries(val.players || {}).map(([k,v]) => ({key:k, ...v}));
      gameState = { ...gameState, ...(val.gameState || {}) };
      updateLobbyUI();
      if (gameState.started) {
        showScreen('gameScreen');
        updateGameUI();
      }
    });
  });
}

function updateLobbyUI() {
  document.getElementById('lobbyPlayers').innerHTML = players.map(p => `
    <div class="player-card ${p.alive ? '' : 'dead'} ${p.isKI ? 'ki' : ''}">
      ${p.name}${p.isKI ? ' ðŸ¤–' : ''}
    </div>
  `).join('');

  document.getElementById('startGameBtn').disabled = !isHost || players.length < 2;
}

document.getElementById('addKI').onclick = () => {
  if (!isHost) return;
  const kiRef = db.ref(`lobbies/${lobbyCode}/players`).push();
  kiRef.set({
    name: `KI-${Math.floor(Math.random()*99)+1}`,
    uid: `ki_${Date.now()}`,
    alive: true,
    isKI: true
  });
};

document.getElementById('startGameBtn').onclick = () => {
  if (!isHost) return;
  gameRef.child('gameState').update({
    started: true,
    bulletPos: Math.floor(Math.random()*6),
    currentPos: 0,
    currentTurn: 0
  });
};

// â”€â”€â”€ GAME LOGIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateGameUI() {
  const curr = players[gameState.currentTurn] || {name:'?'};
  document.getElementById('currentTurnDisplay').textContent = `Dran: ${curr.name}`;

  document.getElementById('gamePlayers').innerHTML = players.map((p,i) => `
    <div class="player-card ${p.alive?'':'dead'} ${p.isKI?'ki':''} ${i===gameState.currentTurn?'current':''}">
      ${p.name}${p.isKI?' ðŸ¤–':''}
    </div>
  `).join('');

  const left = gameState.chambers - gameState.currentPos - 1;
  document.getElementById('status').textContent = left >= 0 ? `Noch ${left} Schuss${left!==1?'e':''}...` : 'Trommel leer';

  const myTurn = players[gameState.currentTurn]?.uid === user?.uid;
  ['shoot','doubleShoot','giveUp','spin'].forEach(id => {
    document.getElementById(id).disabled = !myTurn;
  });

  if (players[gameState.currentTurn]?.isKI && myTurn) {
    setTimeout(() => {
      Math.random() > 0.4 ? doShoot(1) : doShoot(2);
    }, 1400 + Math.random()*2800);
  }
}

function doShoot(multi = 1) {
  const gun = document.getElementById('gun');
  gun.classList.add('shoot');
  setTimeout(() => gun.classList.remove('shoot'), 500);
  createBangParticles();

  let pos = gameState.currentPos;
  let bang = false;

  for (let i = 0; i < multi; i++) {
    pos = (pos + 1) % gameState.chambers;
    if (pos === gameState.bulletPos) {
      bang = true;
      break;
    }
  }

  if (bang) {
    const key = players[gameState.currentTurn].key;
    gameRef.child(`players/${key}`).update({alive: false});
    document.getElementById('status').textContent = `BANG! ${players[gameState.currentTurn].name} tot!`;
    checkGameOver();
  } else {
    gameRef.child('gameState').update({currentPos: pos});
    gameRef.child('gameState/currentTurn').transaction(t => {
      let next = (t + 1) % players.length;
      while (!players[next]?.alive) next = (next + 1) % players.length;
      return next;
    });
  }
}

document.getElementById('shoot').onclick       = () => doShoot(1);
document.getElementById('doubleShoot').onclick = () => doShoot(2);
document.getElementById('giveUp').onclick = () => {
  const key = players[gameState.currentTurn].key;
  gameRef.child(`players/${key}`).update({alive: false});
  document.getElementById('status').textContent = `${players[gameState.currentTurn].name} gibt auf...`;
  checkGameOver();
};

document.getElementById('spin').onclick = () => {
  gameRef.child('gameState').update({
    bulletPos: Math.floor(Math.random()*6),
    currentPos: 0
  });
};

document.getElementById('gun').onclick = () => {
  if (!document.getElementById('shoot').disabled) doShoot(1);
};

function checkGameOver() {
  const alive = players.filter(p => p.alive).length;
  if (alive <= 1) {
    setTimeout(() => {
      const winner = alive === 1 ? players.find(p => p.alive)?.name : 'Unentschieden';
      alert(`Spiel vorbei! Gewinner: ${winner}`);
      location.reload();
    }, 2500);
  }
}

// Auto-Update
setInterval(() => {
  if (document.getElementById('gameScreen').classList.contains('active')) {
    updateGameUI();
  }
}, 400);
</script>

</body>
</html>
