<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Night City Multiplayer Roulette</title>

<style>
body{
margin:0;
font-family:Courier New;
background:#050010;
color:white;
text-align:center;
}

button,input{
padding:10px 20px;
margin:5px;
background:black;
color:#00ffff;
border:2px solid #00ffff;
cursor:pointer;
}

button:hover{background:#00ffff;color:black;}
.hidden{display:none;}

#gameArea{
position:relative;
width:600px;
height:600px;
margin:20px auto;
}
#circle{
position:absolute;
inset:0;
border-radius:50%;
border:2px solid #00ffff;
}
.playerLabel{
position:absolute;
transform:translate(-50%,-50%);
}
.dead{
opacity:0.3;
text-decoration:line-through;
}
#arrow{
position:absolute;
width:0;height:0;
border-left:15px solid transparent;
border-right:15px solid transparent;
border-bottom:30px solid yellow;
top:-15px;
left:50%;
transform-origin:center bottom;
transition:0.5s;
}
</style>
</head>

<body>

<div id="startScreen">
<h1>Night City Roulette</h1>
<input id="nameInput" placeholder="Your name"><br>
<button id="enterBtn">ENTER</button>
</div>

<div id="menuScreen" class="hidden">
<h2>Lobby</h2>
<input id="lobbyCodeInput" placeholder="Lobby Code">
<button id="createBtn">Create</button>
<button id="joinBtn">Join</button>
</div>

<div id="lobbyScreen" class="hidden">
<h3 id="lobbyInfo"></h3>
<div id="playersList"></div>
<button id="startGameBtn">Start Game</button>
<button id="leaveBtn">Leave</button>
</div>

<div id="gameScreen" class="hidden">
<h2 id="status"></h2>

<div id="gameArea">
<div id="circle"></div>
<div id="arrow"></div>
</div>

<button id="spinBtn">Spin</button>
<button id="shootBtn">Shoot</button>
<button id="doubleBtn">Double Shoot</button>
<button id="giveUpBtn">Give Up</button>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, set, update, remove, onValue } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig={
apiKey:"AIzaSyBa5w0hQ1v7Nowk-BvDgkGeNRNf1WJtDgw",
authDomain:"rrweb-dc73f.firebaseapp.com",
databaseURL:"https://rrweb-dc73f-default-rtdb.europe-west1.firebasedatabase.app",
projectId:"rrweb-dc73f"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

let playerName="";
let lobbyId=null;
let players={};
let gameData=null;

const startScreen=document.getElementById("startScreen");
const menuScreen=document.getElementById("menuScreen");
const lobbyScreen=document.getElementById("lobbyScreen");
const gameScreen=document.getElementById("gameScreen");

const enterBtn=document.getElementById("enterBtn");
const createBtn=document.getElementById("createBtn");
const joinBtn=document.getElementById("joinBtn");
const startGameBtn=document.getElementById("startGameBtn");
const leaveBtn=document.getElementById("leaveBtn");

const spinBtn=document.getElementById("spinBtn");
const shootBtn=document.getElementById("shootBtn");
const doubleBtn=document.getElementById("doubleBtn");
const giveUpBtn=document.getElementById("giveUpBtn");

enterBtn.onclick=()=>{
playerName=document.getElementById("nameInput").value||"Player"+Math.floor(Math.random()*100);
startScreen.classList.add("hidden");
menuScreen.classList.remove("hidden");
};

function randomCode(){
return Math.random().toString(36).substring(2,7).toUpperCase();
}

createBtn.onclick=()=>{
lobbyId=randomCode();
set(ref(db,"lobbies/"+lobbyId),{
players:{[playerName]:{alive:true}},
game:{state:"lobby"}
});
listenLobby();
menuScreen.classList.add("hidden");
lobbyScreen.classList.remove("hidden");
document.getElementById("lobbyInfo").innerText="Code: "+lobbyId;
};

joinBtn.onclick=()=>{
lobbyId=document.getElementById("lobbyCodeInput").value.trim().toUpperCase();
if(!lobbyId)return alert("Enter code");
update(ref(db,"lobbies/"+lobbyId+"/players"),{
[playerName]:{alive:true}
});
listenLobby();
menuScreen.classList.add("hidden");
lobbyScreen.classList.remove("hidden");
document.getElementById("lobbyInfo").innerText="Code: "+lobbyId;
};

function listenLobby(){
onValue(ref(db,"lobbies/"+lobbyId),(snap)=>{
if(!snap.exists()){alert("Lobby deleted");return;}
let data=snap.val();
players=data.players;
renderPlayers();
if(data.game.state==="playing"){
startGameListener();
}
});
}

function renderPlayers(){
const div=document.getElementById("playersList");
div.innerHTML="";
for(let p in players){
div.innerHTML+="<div>"+p+"</div>";
}
}

startGameBtn.onclick=()=>{
let names=Object.keys(players);
update(ref(db,"lobbies/"+lobbyId+"/game"),{
state:"playing",
bullet:Math.floor(Math.random()*6),
chamber:0,
turn:names[0]
});
};

function startGameListener(){
lobbyScreen.classList.add("hidden");
gameScreen.classList.remove("hidden");

onValue(ref(db,"lobbies/"+lobbyId+"/game"),(snap)=>{
gameData=snap.val();
renderGame();
});
}

function renderGame(){
document.getElementById("status").innerText="Turn: "+gameData.turn;
renderCircle();
updateButtons();
}

function renderCircle(){
const area=document.getElementById("gameArea");
area.querySelectorAll(".playerLabel").forEach(e=>e.remove());

const names=Object.keys(players);
const radius=230;
const cx=300;
const cy=300;

names.forEach((p,i)=>{
const angle=(i/names.length)*2*Math.PI;
const x=cx+radius*Math.cos(angle);
const y=cy+radius*Math.sin(angle);

let div=document.createElement("div");
div.className="playerLabel";
div.style.left=x+"px";
div.style.top=y+"px";
div.textContent=p;

if(!players[p].alive)div.classList.add("dead");

area.appendChild(div);
});

let index=names.indexOf(gameData.turn);
let deg=(index/names.length)*360;
document.getElementById("arrow").style.transform="rotate("+deg+"deg)";
}

function updateButtons(){
let isTurn=(gameData.turn===playerName);
spinBtn.disabled=!isTurn;
shootBtn.disabled=!isTurn;
doubleBtn.disabled=!isTurn;
giveUpBtn.disabled=!isTurn;
}

function nextTurn(){
let names=Object.keys(players).filter(p=>players[p].alive);
let i=names.indexOf(gameData.turn);
let next=names[(i+1)%names.length];
update(ref(db,"lobbies/"+lobbyId+"/game/turn"),next);
}

shootBtn.onclick=()=>shoot(1);
doubleBtn.onclick=()=>shoot(2);

function shoot(times){
if(gameData.turn!==playerName)return;

let chamber=(gameData.chamber+times)%6;
let alive=true;

if(chamber===gameData.bullet){
alive=false;
update(ref(db,"lobbies/"+lobbyId+"/players/"+playerName+"/alive"),false);
}

update(ref(db,"lobbies/"+lobbyId+"/game/chamber"),chamber);

if(alive){
nextTurn();
}else{
setTimeout(checkWinner,300);
}
}

giveUpBtn.onclick=()=>{
update(ref(db,"lobbies/"+lobbyId+"/players/"+playerName+"/alive"),false);
nextTurn();
};

function checkWinner(){
let alive=Object.keys(players).filter(p=>players[p].alive);
if(alive.length===1){
alert("Winner: "+alive[0]);
}
}

leaveBtn.onclick=()=>{
remove(ref(db,"lobbies/"+lobbyId+"/players/"+playerName));
menuScreen.classList.remove("hidden");
lobbyScreen.classList.add("hidden");
gameScreen.classList.add("hidden");
};

</script>

</body>
</html>
